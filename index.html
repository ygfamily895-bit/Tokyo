<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Niji Trip 2026 ãƒ»æš–è‰²è¡Œç¨‹è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #ffe3b3;
      --bg-soft: #fff7e8;
      --bg-card: #fffaf2;
      --bg-day: #e9f5ff;
      --accent: #ffb347;
      --accent-deep: #ff9a3c;
      --brown-main: #7b4b26;
      --brown-soft: #9c6c3a;
      --border-soft: #f1cfa3;
      --pink: #ffb3c6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg-main);
      color: var(--brown-main);
    }

    h1, h2, h3, p {
      margin: 0;
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 12px 12px 80px;
    }

    /* ---------- é ‚éƒ¨æ¨™é¡Œå€ ---------- */

    .hero {
      background: var(--bg-soft);
      border-radius: 20px;
      padding: 20px 18px 16px;
      box-shadow: 0 3px 6px rgba(190, 150, 110, 0.35);
      margin-bottom: 12px;
    }

    .hero-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .hero-title {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.05em;
    }

    .hero-emoji {
      font-size: 26px;
    }

    .hero-text {
      font-size: 14px;
      line-height: 1.7;
      color: var(--brown-soft);
      margin-top: 4px;
    }

    .hero-text [contenteditable="true"] {
      outline: none;
      border-radius: 6px;
      padding: 2px 4px;
    }

    .hero-text [contenteditable="true"]:focus {
      background: #fff2d6;
      box-shadow: 0 0 0 1px var(--accent-deep);
    }

    .hero-buttons {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      background: #ffe0ad;
      color: var(--brown-main);
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(190, 150, 110, 0.35);
      white-space: nowrap;
    }

    .btn:hover {
      background: #ffd390;
    }

    .btn-primary {
      background: var(--accent);
      color: #5b320e;
      font-weight: 600;
    }

    .btn-primary:hover {
      background: var(--accent-deep);
    }

    .btn-danger {
      background: #ffd1cf;
      color: #8b2b2b;
    }

    .btn-danger:hover {
      background: #ffbab7;
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
      box-shadow: none;
    }

    /* ---------- Day å°è¦½åˆ— ---------- */

    .day-nav-wrap {
      position: sticky;
      top: 0;
      z-index: 5;
      padding: 4px 0 8px;
      background: linear-gradient(to bottom, rgba(255, 227, 179, 0.96), rgba(255, 227, 179, 0.0));
      margin-bottom: 8px;
    }

    .day-nav {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 6px 2px 4px;
    }

    .day-chip {
      flex: 0 0 auto;
      min-width: 90px;
      padding: 8px 10px 6px;
      border-radius: 999px;
      background: #fffaf4;
      border: 2px solid #f5dfc1;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(190, 150, 110, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .day-chip-main {
      font-weight: 700;
    }

    .day-chip-sub {
      display: block;
      font-size: 11px;
      margin-top: 1px;
      color: var(--brown-soft);
    }

    .day-chip.active {
      background: var(--accent);
      color: #5b320e;
      border-color: #ffcf8d;
    }

    .day-chip.active .day-chip-sub {
      color: #5b320e;
    }

    .day-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(190, 150, 110, 0.45);
    }

    /* ---------- æ¯æ—¥å€å¡Š ---------- */

    .day-list {
      margin-top: 4px;
    }

    .day-section {
      background: var(--bg-day);
      border-radius: 22px;
      padding: 16px 14px 18px;
      margin-bottom: 14px;
      box-shadow: 0 3px 6px rgba(130, 160, 190, 0.4);
      position: relative;
    }

    .day-section.dragging {
      opacity: 0.7;
      transform: scale(0.995);
    }

    .day-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
    }

    .day-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .day-title-label {
      background: #fff;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(140, 160, 190, 0.4);
      font-size: 16px;
    }

    .day-title-editable {
      font-size: 14px;
      color: var(--brown-soft);
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.7);
      min-height: 24px;
      flex: 1;
      outline: none;
    }

    .day-title-editable:focus {
      background: #fff7e8;
      box-shadow: 0 0 0 1px var(--accent-deep);
    }

    .day-date-row {
      font-size: 13px;
      color: var(--brown-soft);
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px 0;
    }

    .day-date {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      outline: none;
      min-width: 40px;
      text-align: center;
    }

    .day-date:focus {
      box-shadow: 0 0 0 1px var(--accent-deep);
      background: #fff7e8;
    }

    /* ---------- è¡Œç¨‹å¡ç‰‡ ---------- */

    .spot-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .spot-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 12px 12px 10px;
      border: 1px solid #f3d9b7;
      box-shadow: 0 2px 4px rgba(180, 150, 110, 0.35);
      position: relative;
    }

    .spot-card.dragging {
      opacity: 0.7;
      transform: scale(0.995);
    }

    .spot-drag-handle {
      font-size: 11px;
      color: var(--brown-soft);
      margin-bottom: 6px;
      cursor: grab;
      user-select: none;
    }

    .spot-text .name-zh,
    .spot-text .name-ja,
    .spot-text .spot-meta {
      outline: none;
    }

    .spot-text .name-zh {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .spot-text .name-ja {
      font-size: 14px;
      color: var(--brown-soft);
      margin-bottom: 4px;
    }

    .spot-text .spot-meta {
      font-size: 13px;
      color: var(--brown-soft);
      margin-bottom: 6px;
    }

    .spot-text [contenteditable="true"]:focus {
      background: #fff7e8;
      border-radius: 6px;
      box-shadow: 0 0 0 1px var(--accent-deep);
      padding: 2px 4px;
      margin: 0 -4px;
    }

    .spot-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .btn-ghost {
      background: #fffdf9;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid #f1dec6;
      box-shadow: none;
    }

    .btn-ghost:hover {
      background: #fff4dd;
    }

    .spot-note-box {
      margin-top: 4px;
      font-size: 12px;
      color: var(--brown-soft);
      background: #fffdf8;
      border-radius: 10px;
      border: 1px dashed #f1cfa3;
      padding: 6px 8px;
    }

    .spot-note-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .spot-note {
      outline: none;
      white-space: pre-wrap;
      min-height: 18px;
    }

    .spot-note:focus {
      background: #fff7e8;
      border-radius: 6px;
      box-shadow: 0 0 0 1px var(--accent-deep);
      padding: 2px 4px;
      margin: 0 -4px;
    }

    .image-list,
    .note-image-list {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .spot-photo,
    .note-photo {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 1px 3px rgba(180, 150, 110, 0.4);
      cursor: pointer;
    }

    /* ---------- æ–°å¢è¡Œç¨‹å¡ç‰‡ ---------- */

    .add-spot-row {
      margin-top: 10px;
      padding: 10px 10px 8px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.86);
      border: 1px dashed #f3c48f;
    }

    .add-spot-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .add-spot-inputs {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 6px;
    }

    .input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #f1dec6;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      background: #fffdf9;
    }

    .input:focus {
      border-color: var(--accent-deep);
      box-shadow: 0 0 0 1px var(--accent-deep);
      background: #fff;
    }

    /* ---------- ç•¶æ—¥å‚™è¨»ï¼èŠ±è²» ---------- */

    .day-note-box {
      margin-top: 12px;
      background: var(--bg-soft);
      border-radius: 16px;
      border: 1px dashed #e4c093;
      padding: 8px 10px 10px;
    }

    .day-note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .day-note-title {
      font-size: 14px;
      font-weight: 700;
    }

    .day-note-body {
      font-size: 13px;
      color: var(--brown-soft);
      background: #fffdf9;
      border-radius: 10px;
      padding: 6px 8px;
      min-height: 40px;
      outline: none;
      white-space: pre-wrap;
    }

    .day-note-body:focus {
      box-shadow: 0 0 0 1px var(--accent-deep);
      background: #fff7e8;
    }

    /* ---------- å°è£ç½®èª¿æ•´ ---------- */

    @media (max-width: 600px) {
      .hero {
        border-radius: 16px;
        padding: 16px 12px 12px;
      }

      .hero-title {
        font-size: 24px;
      }

      .day-section {
        padding: 14px 10px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!--  é ‚éƒ¨æ¨™é¡Œå€  -->
    <section class="hero" id="hero">
      <div class="hero-title-row">
        <h1 class="hero-title" contenteditable="true">Niji Trip 2026</h1>
        <div class="hero-emoji">ğŸŒˆ</div>
      </div>
      <div class="hero-text">
        <div contenteditable="true">
          æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œãƒ»è¡Œç¨‹æ¬„ä½å¯æ‹–æ‹‰æ’åºï¼Œå¤©æ•¸å¯æ‹–æ‹‰é‡æ’ï¼‹è‡ªå‹• Day ç·¨è™Ÿã€‚
        </div>
        <div contenteditable="true">
          âœï¸ æ¯ä¸€å¤©çš„ã€Œç•¶æ—¥å‚™è¨»ï¼èŠ±è²»ã€ç¶­æŒåœ¨æœ€ä¸‹æ–¹ï¼Œæ–‡å­—å¯ç·¨è¼¯ï¼Œä¹Ÿå¯ä»¥åŠ å…¥ç…§ç‰‡ã€‚
        </div>
      </div>

      <div class="hero-buttons">
        <button class="btn" id="btnExport">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
        <button class="btn" id="btnImport">åŒ¯å…¥å‚™ä»½</button>
        <button class="btn btn-primary" id="btnAddDay">ï¼‹ æ–°å¢ä¸€å¤©</button>
        <button class="btn btn-danger" id="btnRemoveDay">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
      </div>

      <!-- åŒ¯å…¥ç”¨çš„éš±è— input -->
      <input type="file" id="backupFile" accept="application/json" style="display:none" />
    </section>

    <!-- Day å°è¦½åˆ— -->
    <div class="day-nav-wrap">
      <div class="day-nav" id="dayNav"></div>
    </div>

    <!-- ä¸»å…§å®¹ï¼šæ¯æ—¥å€å¡Š -->
    <main class="day-list" id="dayList">
      <!-- åˆå§‹ Day 1 æ¨£æ¿ -->
      <section class="day-section" draggable="true">
        <header class="day-header">
          <div class="day-title-row">
            <div class="day-title-label">
              Day <span class="day-number">1</span>
            </div>
            <div
              class="day-title-editable"
              contenteditable="true"
            >ï¼ˆç¯„ä¾‹ï¼‰æˆç”°æ©Ÿå ´ãƒ»å…¥ä½ä¸Šé‡</div>
          </div>
          <div class="day-date-row">
            <span>æ—¥æœŸï¼š</span>
            <span class="day-date" contenteditable="true" data-date="2026-05-08">5/8</span>
            <span style="font-size:11px;color:var(--brown-soft);">ï¼ˆåªè¦ä¿®æ”¹ Day1ï¼Œå…¶é¤˜æ—¥æœŸæœƒè‡ªå‹•æ›´æ–°ï¼‰</span>
          </div>
        </header>

        <div class="spot-list">
          <!-- ç¯„ä¾‹æ™¯é»å¡ç‰‡ -->
          <article class="spot-card" draggable="true">
            <div class="spot-drag-handle">â‹®â‹® æ‹–æ‹‰æ•´å¼µå¡ç‰‡å¯ä»¥èª¿æ•´é †åº</div>
            <div class="spot-text">
              <div class="name-zh" contenteditable="true">ç¯„ä¾‹æ™¯é»</div>
              <div class="name-ja" contenteditable="true">æ—¥æ–‡åç¨±æˆ–åœ°å€</div>
              <div class="spot-meta" contenteditable="true">
                åœ°å€ãƒ»ç°¡çŸ­èªªæ˜å¯å¯«åœ¨é€™è£¡
              </div>
            </div>

            <div class="spot-buttons">
              <button class="btn btn-ghost btn-map">åœ°åœ–é è¦½</button>
              <button class="btn btn-ghost btn-photo-spot">ğŸ“· æ–°å¢åœ–ç‰‡</button>
              <button class="btn btn-ghost btn-delete-spot">åˆªé™¤å¡ç‰‡</button>
            </div>

            <div class="spot-note-box">
              <div class="spot-note-title">å‚™è¨»</div>
              <div class="spot-note" contenteditable="true">
å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰â€¦
              </div>
              <div class="image-list"></div>
            </div>
          </article>
        </div>

        <!-- æ–°å¢è¡Œç¨‹å¡ç‰‡ -->
        <div class="add-spot-row">
          <div class="add-spot-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
          <div class="add-spot-inputs">
            <input
              type="text"
              class="input input-name-zh"
              placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰"
            />
            <input
              type="text"
              class="input input-name-ja"
              placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€"
            />
            <input
              type="text"
              class="input input-meta"
              placeholder="åœ°å€ãƒ»ç°¡çŸ­èªªæ˜"
            />
          </div>
          <button class="btn btn-primary btn-create-spot">æ–°å¢</button>
        </div>

        <!-- ç•¶æ—¥å‚™è¨»ï¼èŠ±è²» -->
        <section class="day-note-box">
          <div class="day-note-header">
            <div class="day-note-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
            <button class="btn btn-sm btn-photo-note">ğŸ“· æ–°å¢åœ–ç‰‡</button>
          </div>
          <div
            class="day-note-body"
            contenteditable="true"
          >ä¾‹ï¼šé¤é£² xxx å…ƒã€äº¤é€š xxx å…ƒã€è³¼ç‰© xxx å…ƒã€å…¶ä»–å¿ƒå¾—â€¦â€¦</div>
          <div class="note-image-list"></div>
        </section>
      </section>
    </main>
  </div>

  <!-- å…±ç”¨åœ–ç‰‡ inputï¼ˆé»ä¸åŒæŒ‰éˆ•æ™‚æœƒæŒ‡å‘ä¸åŒç›®æ¨™ï¼‰ -->
  <input
    type="file"
    id="photoInput"
    accept="image/*"
    style="display:none"
  />

  <script>
    (function () {
      const STORAGE_KEY = "niji-trip-2026-v2";

      const dayList = document.getElementById("dayList");
      const dayNav = document.getElementById("dayNav");
      const hero = document.getElementById("hero");
      const btnAddDay = document.getElementById("btnAddDay");
      const btnRemoveDay = document.getElementById("btnRemoveDay");
      const btnExport = document.getElementById("btnExport");
      const btnImport = document.getElementById("btnImport");
      const backupFileInput = document.getElementById("backupFile");
      const photoInput = document.getElementById("photoInput");

      let currentPhotoTarget = null;
      let draggingDay = null;

      /* ---------- å·¥å…·ï¼šæ—¥æœŸè™•ç† ---------- */

      function parseDateText(text) {
        // æ”¯æ´ "5/8" æˆ– "2026/5/8"
        const parts = text.trim().split(/[\/\-]/);
        if (parts.length < 2) return null;

        let year, month, day;
        if (parts.length === 2) {
          year = new Date().getFullYear();
          month = parseInt(parts[0], 10) - 1;
          day = parseInt(parts[1], 10);
        } else {
          year = parseInt(parts[0], 10);
          month = parseInt(parts[1], 10) - 1;
          day = parseInt(parts[2], 10);
        }
        if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
        return new Date(year, month, day);
      }

      function formatDateMD(date) {
        return date.getMonth() + 1 + "/" + date.getDate();
      }

      /* ---------- å„²å­˜ï¼è®€å– ---------- */

      function saveState() {
        const data = {
          hero: hero.innerHTML,
          days: dayList.innerHTML
        };
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
          console.warn("ç„¡æ³•å­˜åˆ° localStorageï¼š", e);
        }
      }

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          const data = JSON.parse(raw);
          if (data.hero) hero.innerHTML = data.hero;
          if (data.days) dayList.innerHTML = data.days;
        } catch (e) {
          console.warn("è§£æå‚™ä»½å¤±æ•—ï¼Œä½¿ç”¨é è¨­å…§å®¹ã€‚", e);
        }
      }

      /* ---------- Day ç·¨è™Ÿ & æ—¥æœŸ & å°è¦½åˆ— ---------- */

      function recalcDays() {
        const sections = Array.from(
          dayList.querySelectorAll(".day-section")
        );
        if (sections.length === 0) return;

        // ä»¥ç¬¬ä¸€å¤©æ—¥æœŸç‚ºåŸºæº–
        const firstDateEl = sections[0].querySelector(".day-date");
        let baseDate = parseDateText(firstDateEl.textContent || "");
        if (!baseDate) {
          baseDate = new Date();
        }

        sections.forEach((sec, index) => {
          const n = index + 1;
          const numEl = sec.querySelector(".day-number");
          if (numEl) numEl.textContent = n;

          const dateEl = sec.querySelector(".day-date");
          if (!dateEl) return;
          if (index === 0) {
            // ä¿ç•™ä½¿ç”¨è€…è¼¸å…¥çš„æ–‡å­—ï¼Œä½†æ›´æ–° data-date
            const d = parseDateText(dateEl.textContent || "");
            const real = d || baseDate;
            dateEl.dataset.date = real.toISOString().slice(0, 10);
            baseDate = real;
          } else {
            const d = new Date(baseDate.getTime());
            d.setDate(d.getDate() + index);
            dateEl.dataset.date = d.toISOString().slice(0, 10);
            dateEl.textContent = formatDateMD(d);
          }
        });
      }

      function renderDayNav() {
        const sections = Array.from(
          dayList.querySelectorAll(".day-section")
        );
        dayNav.innerHTML = "";
        sections.forEach((sec, index) => {
          const num = index + 1;
          const dateEl = sec.querySelector(".day-date");
          const labelEl = sec.querySelector(".day-title-editable");
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "day-chip";
          chip.dataset.index = index;

          const main = document.createElement("span");
          main.className = "day-chip-main";
          main.textContent = "Day " + num;
          chip.appendChild(main);

          const sub = document.createElement("span");
          sub.className = "day-chip-sub";
          const dateText = dateEl ? dateEl.textContent.trim() : "";
          const labelText = labelEl
            ? labelEl.textContent.trim()
            : "";
          sub.textContent = dateText + (labelText ? "ãƒ»" + labelText : "");
          chip.appendChild(sub);

          chip.addEventListener("click", () => {
            sec.scrollIntoView({ behavior: "smooth", block: "start" });
          });

          dayNav.appendChild(chip);
        });
      }

      /* ---------- è¡Œç¨‹å¡ç‰‡ï¼šå»ºç«‹ï¼äº‹ä»¶ ---------- */

      function createSpotCard(nameZh, nameJa, meta) {
        const card = document.createElement("article");
        card.className = "spot-card";
        card.draggable = true;
        card.innerHTML = `
          <div class="spot-drag-handle">â‹®â‹® æ‹–æ‹‰æ•´å¼µå¡ç‰‡å¯ä»¥èª¿æ•´é †åº</div>
          <div class="spot-text">
            <div class="name-zh" contenteditable="true"></div>
            <div class="name-ja" contenteditable="true"></div>
            <div class="spot-meta" contenteditable="true"></div>
          </div>
          <div class="spot-buttons">
            <button class="btn btn-ghost btn-map">åœ°åœ–é è¦½</button>
            <button class="btn btn-ghost btn-photo-spot">ğŸ“· æ–°å¢åœ–ç‰‡</button>
            <button class="btn btn-ghost btn-delete-spot">åˆªé™¤å¡ç‰‡</button>
          </div>
          <div class="spot-note-box">
            <div class="spot-note-title">å‚™è¨»</div>
            <div class="spot-note" contenteditable="true"></div>
            <div class="image-list"></div>
          </div>
        `;

        card.querySelector(".name-zh").textContent =
          nameZh || "æ–°æ™¯é»";
        if (nameJa)
          card.querySelector(".name-ja").textContent = nameJa;
        if (meta)
          card.querySelector(".spot-meta").textContent = meta;

        return card;
      }

      function attachPhotoToTarget(target, files) {
        if (!files || files.length === 0) return;
        const list =
          target.classList.contains("day-note-box") ||
          target.classList.contains("day-note-body")
            ? target
                .closest(".day-note-box")
                .querySelector(".note-image-list")
            : target.closest(".spot-card").querySelector(".image-list");

        Array.from(files).forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.className = list.classList.contains("note-image-list")
              ? "note-photo"
              : "spot-photo";
            list.appendChild(img);
            saveState();
          };
          reader.readAsDataURL(file);
        });
      }

      /* ---------- åˆå§‹åŒ– Day å€å¡Š ---------- */

      function initDaySection(sec) {
        // æ–°å¢è¡Œç¨‹å¡ç‰‡æŒ‰éˆ•
        const btnCreate = sec.querySelector(".btn-create-spot");
        if (btnCreate) {
          btnCreate.addEventListener("click", () => {
            const nameZhInput = sec.querySelector(".input-name-zh");
            const nameJaInput = sec.querySelector(".input-name-ja");
            const metaInput = sec.querySelector(".input-meta");
            const nameZh = nameZhInput.value.trim() || "æ–°æ™¯é»";
            const nameJa = nameJaInput.value.trim();
            const meta = metaInput.value.trim();

            const spotList = sec.querySelector(".spot-list");
            const card = createSpotCard(nameZh, nameJa, meta);
            spotList.appendChild(card);

            nameZhInput.value = "";
            nameJaInput.value = "";
            metaInput.value = "";
            saveState();
          });
        }

        // Day æ—¥æœŸï¼šåªè¦ä¿®æ”¹ç¬¬ä¸€å¤©å°±æœƒå¸¶å‹•å…¶é¤˜å¤©
        const dateEl = sec.querySelector(".day-date");
        if (dateEl) {
          dateEl.addEventListener("input", () => {
            recalcDays();
            renderDayNav();
            saveState();
          });
        }

        // Day æ¨™é¡Œè‡ªç”±ç·¨è¼¯
        const editableTitle = sec.querySelector(".day-title-editable");
        if (editableTitle) {
          editableTitle.addEventListener("input", () => {
            renderDayNav();
            saveState();
          });
        }

        // ç•¶æ—¥å‚™è¨»ï¼èŠ±è²» æ–°å¢åœ–ç‰‡
        const btnNotePhoto = sec.querySelector(".btn-photo-note");
        if (btnNotePhoto) {
          btnNotePhoto.addEventListener("click", () => {
            currentPhotoTarget = sec.querySelector(".day-note-body");
            photoInput.value = "";
            photoInput.click();
          });
        }

        const noteBody = sec.querySelector(".day-note-body");
        if (noteBody) {
          noteBody.addEventListener("input", () => {
            saveState();
          });
        }

        // è¡Œç¨‹å¡ç‰‡å…§çš„äº‹ä»¶ç”¨äº‹ä»¶å§”æ´¾
        const spotList = sec.querySelector(".spot-list");
        if (spotList && !spotList.dataset.inited) {
          spotList.dataset.inited = "1";

          spotList.addEventListener("click", (e) => {
            const card = e.target.closest(".spot-card");
            if (!card) return;

            if (e.target.classList.contains("btn-photo-spot")) {
              currentPhotoTarget = card;
              photoInput.value = "";
              photoInput.click();
            } else if (
              e.target.classList.contains("btn-delete-spot")
            ) {
              if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å¡ç‰‡å—ï¼Ÿ")) {
                card.remove();
                saveState();
              }
            } else if (e.target.classList.contains("btn-map")) {
              const name =
                card.querySelector(".name-zh").textContent.trim() ||
                card.querySelector(".name-ja").textContent.trim();
              if (!name) return;
              const url =
                "https://www.google.com/maps/search/" +
                encodeURIComponent(name);
              window.open(url, "_blank");
            }
          });

          // è¡Œç¨‹å¡ç‰‡æ‹–æ‹‰æ’åº
          let draggingSpot = null;

          spotList.addEventListener("dragstart", (e) => {
            const card = e.target.closest(".spot-card");
            if (!card) return;
            draggingSpot = card;
            card.classList.add("dragging");
          });

          spotList.addEventListener("dragend", () => {
            if (draggingSpot) draggingSpot.classList.remove("dragging");
            draggingSpot = null;
            saveState();
          });

          spotList.addEventListener("dragover", (e) => {
            e.preventDefault();
            const after = getDragAfterElement(
              spotList,
              e.clientY,
              ".spot-card"
            );
            if (!draggingSpot) return;
            if (!after) {
              spotList.appendChild(draggingSpot);
            } else {
              spotList.insertBefore(draggingSpot, after);
            }
          });
        }
      }

      /* ---------- æ‹–æ‹‰æ’åºå…±ç”¨å·¥å…· ---------- */

      function getDragAfterElement(container, y, selector) {
        const elements = [
          ...container.querySelectorAll(selector + ":not(.dragging)")
        ];

        let closest = null;
        let closestOffset = Number.POSITIVE_INFINITY;
        elements.forEach((child) => {
          const box = child.getBoundingClientRect();
          const offset = box.top + box.height / 2 - y;
          if (offset > 0 && offset < closestOffset) {
            closestOffset = offset;
            closest = child;
          }
        });
        return closest;
      }

      /* ---------- åˆå§‹åŒ–å…¨éƒ¨ ---------- */

      function attachGlobalEvents() {
        // æ–°å¢ï¼åˆªé™¤å¤©æ•¸
        btnAddDay.addEventListener("click", () => {
          const sections = dayList.querySelectorAll(".day-section");
          const last =
            sections[sections.length - 1] || dayList.firstElementChild;
          const clone = last.cloneNode(true);

          // æ¸…ç©º clone è£¡çš„è¡Œç¨‹èˆ‡å‚™è¨»
          clone.querySelector(".day-title-editable").textContent =
            "ï¼ˆæ–°çš„ä¸€å¤©æ¨™é¡Œï¼‰";
          const spotList = clone.querySelector(".spot-list");
          spotList.innerHTML = "";
          const dateEl = clone.querySelector(".day-date");
          dateEl.textContent = ""; // å…ˆç©ºç™½ï¼ŒrecalcDays æœƒå¡«
          const noteBody = clone.querySelector(".day-note-body");
          if (noteBody) {
            noteBody.textContent =
              "ä¾‹ï¼šé¤é£² xxx å…ƒã€äº¤é€š xxx å…ƒã€è³¼ç‰© xxx å…ƒã€å…¶ä»–å¿ƒå¾—â€¦â€¦";
          }
          const noteImages = clone.querySelector(".note-image-list");
          if (noteImages) noteImages.innerHTML = "";

          dayList.appendChild(clone);
          initDaySection(clone);
          recalcDays();
          renderDayNav();
          saveState();
        });

        btnRemoveDay.addEventListener("click", () => {
          const sections = dayList.querySelectorAll(".day-section");
          if (sections.length <= 1) {
            alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©è¡Œç¨‹å”·ï¼");
            return;
          }
          if (!confirm("ç¢ºå®šè¦åˆªé™¤æœ€å¾Œä¸€å¤©å—ï¼Ÿ")) return;
          sections[sections.length - 1].remove();
          recalcDays();
          renderDayNav();
          saveState();
        });

        // Day å€å¡Šæ‹–æ‹‰æ’åº
        dayList.addEventListener("dragstart", (e) => {
          const sec = e.target.closest(".day-section");
          if (!sec) return;
          draggingDay = sec;
          sec.classList.add("dragging");
        });

        dayList.addEventListener("dragend", () => {
          if (draggingDay) draggingDay.classList.remove("dragging");
          draggingDay = null;
          recalcDays();
          renderDayNav();
          saveState();
        });

        dayList.addEventListener("dragover", (e) => {
          e.preventDefault();
          const after = getDragAfterElement(
            dayList,
            e.clientY,
            ".day-section"
          );
          if (!draggingDay) return;
          if (!after) {
            dayList.appendChild(draggingDay);
          } else {
            dayList.insertBefore(draggingDay, after);
          }
        });

        // Hero æ–‡å­—è‡ªå‹•å­˜
        hero.addEventListener("input", () => {
          saveState();
        });

        // åŒ¯å‡ºå‚™ä»½
        btnExport.addEventListener("click", () => {
          const data = {
            savedAt: new Date().toISOString(),
            hero: hero.innerHTML,
            days: dayList.innerHTML
          };
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json"
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "NijiTrip2026_backup.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });

        // åŒ¯å…¥å‚™ä»½
        btnImport.addEventListener("click", () => {
          backupFileInput.value = "";
          backupFileInput.click();
        });

        backupFileInput.addEventListener("change", (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const data = JSON.parse(ev.target.result);
              if (data.hero) hero.innerHTML = data.hero;
              if (data.days) dayList.innerHTML = data.days;
              // é‡æ–°åˆå§‹åŒ–
              initAllDaySections();
              recalcDays();
              renderDayNav();
              saveState();
              alert("åŒ¯å…¥å®Œæˆï¼");
            } catch (err) {
              alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚");
            }
          };
          reader.readAsText(file, "utf-8");
        });

        // å…±ç”¨ç…§ç‰‡ input
        photoInput.addEventListener("change", (e) => {
          if (!currentPhotoTarget) return;
          attachPhotoToTarget(currentPhotoTarget, e.target.files);
          currentPhotoTarget = null;
        });
      }

      function initAllDaySections() {
        const sections = dayList.querySelectorAll(".day-section");
        sections.forEach((sec) => {
          sec.setAttribute("draggable", "true");
          initDaySection(sec);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        // å…ˆè®€å– localStorage
        loadState();

        // ç¶å®šå…¨åŸŸäº‹ä»¶
        attachGlobalEvents();

        // åˆå§‹åŒ–ç›®å‰æ‰€æœ‰ Day
        initAllDaySections();

        // è¨ˆç®— Day ç·¨è™Ÿ & æ—¥æœŸ & å°è¦½åˆ—
        recalcDays();
        renderDayNav();
      });
    })();
  </script>
</body>
</html>
